"use strict";var gsStorage={SCREEN_CAPTURE:"screenCapture",SCREEN_CAPTURE_FORCE:"screenCaptureForce",SUSPEND_IN_PLACE_OF_DISCARD:"suspendInPlaceOfDiscard",UNSUSPEND_ON_FOCUS:"gsUnsuspendOnFocus",SUSPEND_TIME:"gsTimeToSuspend",IGNORE_WHEN_OFFLINE:"onlineCheck",IGNORE_WHEN_CHARGING:"batteryCheck",IGNORE_PINNED:"gsDontSuspendPinned",IGNORE_FORMS:"gsDontSuspendForms",IGNORE_AUDIO:"gsDontSuspendAudio",IGNORE_ACTIVE_TABS:"gsDontSuspendActiveTabs",IGNORE_CACHE:"gsIgnoreCache",ADD_CONTEXT:"gsAddContextMenu",SYNC_SETTINGS:"gsSyncSettings",NO_NAG:"gsNoNag",THEME:"gsTheme",WHITELIST:"gsWhitelist",DISCARD_AFTER_SUSPEND:"discardAfterSuspend",DISCARD_IN_PLACE_OF_SUSPEND:"discardInPlaceOfSuspend",USE_ALT_SCREEN_CAPTURE_LIB:"useAlternateScreenCaptureLib",APP_VERSION:"gsVersion",LAST_NOTICE:"gsNotice",LAST_EXTENSION_RECOVERY:"gsExtensionRecovery",SM_SESSION_METRICS:"gsSessionMetrics",SM_TIMESTAMP:"sessionTimestamp",SM_SUSPENDED_TAB_COUNT:"suspendedTabCount",SM_TOTAL_TAB_COUNT:"totalTabCount",noop:function(){},getSettingsDefaults:function(){const t={};return t[gsStorage.SCREEN_CAPTURE]="0",t[gsStorage.SCREEN_CAPTURE_FORCE]=!1,t[gsStorage.SUSPEND_IN_PLACE_OF_DISCARD]=!1,t[gsStorage.DISCARD_IN_PLACE_OF_SUSPEND]=!1,t[gsStorage.USE_ALT_SCREEN_CAPTURE_LIB]=!1,t[gsStorage.DISCARD_AFTER_SUSPEND]=!1,t[gsStorage.IGNORE_WHEN_OFFLINE]=!1,t[gsStorage.IGNORE_WHEN_CHARGING]=!1,t[gsStorage.UNSUSPEND_ON_FOCUS]=!1,t[gsStorage.IGNORE_PINNED]=!0,t[gsStorage.IGNORE_FORMS]=!0,t[gsStorage.IGNORE_AUDIO]=!0,t[gsStorage.IGNORE_ACTIVE_TABS]=!0,t[gsStorage.IGNORE_CACHE]=!1,t[gsStorage.ADD_CONTEXT]=!0,t[gsStorage.SYNC_SETTINGS]=!0,t[gsStorage.SUSPEND_TIME]="60",t[gsStorage.NO_NAG]=!1,t[gsStorage.WHITELIST]="",t[gsStorage.THEME]="light",t},initSettingsAsPromised:function(){return new Promise((function(t){var e=gsStorage.getSettingsDefaults(),s=Object.keys(e);chrome.storage.sync.get(s,(function(g){var S;gsUtils.log("gsStorage","syncedSettings on init: ",g),gsSession.setSynchedSettingsOnInit(g);try{S=JSON.parse(localStorage.getItem("gsSettings"))}catch(t){gsUtils.error("gsStorage","Failed to parse gsSettings: ",localStorage.getItem("gsSettings"))}S?S[gsStorage.SYNC_SETTINGS]=S[gsStorage.SYNC_SETTINGS]||!1:S={},gsUtils.log("gsStorage","localSettings on init: ",S);var r=S[gsStorage.SYNC_SETTINGS],o={};for(const t of s)t!==gsStorage.SYNC_SETTINGS?t===gsStorage.NO_NAG&&r&&S.hasOwnProperty(gsStorage.NO_NAG)&&S[gsStorage.NO_NAG]?o[gsStorage.NO_NAG]=!0:(!g.hasOwnProperty(t)||S.hasOwnProperty(t)&&!r||(o[t]=g[t]),o.hasOwnProperty(t)||(o[t]=S[t]),void 0!==o[t]&&null!==o[t]||(gsUtils.errorIfInitialised("gsStorage","Missing key: "+t+"! Will init with default."),o[t]=e[t])):chrome.extension.inIncognitoContext?o[t]=!1:o[t]=S.hasOwnProperty(t)?S[t]:e[t];gsStorage.saveSettings(o),gsUtils.log("gsStorage","mergedSettings: ",o);var a=!1;for(const t of s)t!==gsStorage.SYNC_SETTINGS&&g[t]!==o[t]&&(a=!0);a&&gsStorage.syncSettings(),gsStorage.addSettingsSyncListener(),gsUtils.log("gsStorage","init successful"),t()}))}))},addSettingsSyncListener:function(){chrome.storage.onChanged.addListener((function(t,e){if("sync"===e&&t&&gsStorage.getOption(gsStorage.SYNC_SETTINGS)){var s=gsStorage.getSettings(),g=[],S={},r={};Object.keys(t).forEach((function(e){var o=t[e];if(e===gsStorage.NO_NAG&&!1===o.newValue)return!1;s[e]!==o.newValue&&(gsUtils.log("gsStorage","Changed value from sync",e,o.newValue),g.push(e),S[e]=s[e],r[e]=o.newValue,s[e]=o.newValue)})),g.length>0&&(gsStorage.saveSettings(s),gsUtils.performPostSaveUpdates(g,S,r))}}))},getOption:function(t){var e=gsStorage.getSettings();return void 0!==e[t]&&null!==e[t]||(e[t]=gsStorage.getSettingsDefaults()[t],gsStorage.saveSettings(e)),e[t]},setOption:function(t,e){var s=gsStorage.getSettings();s[t]=e,gsStorage.saveSettings(s)},setOptionAndSync:function(t,e){gsStorage.setOption(t,e),gsStorage.syncSettings()},getSettings:function(){var t;try{t=JSON.parse(localStorage.getItem("gsSettings"))}catch(t){gsUtils.error("gsStorage","Failed to parse gsSettings: ",localStorage.getItem("gsSettings"))}return t||(t=gsStorage.getSettingsDefaults(),gsStorage.saveSettings(t)),t},saveSettings:function(t){try{localStorage.setItem("gsSettings",JSON.stringify(t))}catch(t){gsUtils.error("gsStorage","failed to save gsSettings to local storage",t)}},syncSettings:function(){var t=gsStorage.getSettings();t[gsStorage.SYNC_SETTINGS]&&(delete t[gsStorage.SYNC_SETTINGS],gsUtils.log("gsStorage","gsStorage","Pushing local settings to sync",t),chrome.storage.sync.set(t,(()=>{chrome.runtime.lastError&&gsUtils.error("gsStorage","failed to save to chrome.storage.sync: ",chrome.runtime.lastError)})))},fetchLastVersion:function(){var t;try{t=JSON.parse(localStorage.getItem(gsStorage.APP_VERSION))}catch(t){gsUtils.error("gsStorage","Failed to parse "+gsStorage.APP_VERSION+": ",localStorage.getItem(gsStorage.APP_VERSION))}return(t=t||"0.0.0")+""},setLastVersion:function(t){try{localStorage.setItem(gsStorage.APP_VERSION,JSON.stringify(t))}catch(t){gsUtils.error("gsStorage","failed to save "+gsStorage.APP_VERSION+" to local storage",t)}},fetchNoticeVersion:function(){var t;try{t=JSON.parse(localStorage.getItem(gsStorage.LAST_NOTICE))}catch(t){gsUtils.error("gsStorage","Failed to parse "+gsStorage.LAST_NOTICE+": ",localStorage.getItem(gsStorage.LAST_NOTICE))}return(t=t||"0")+""},setNoticeVersion:function(t){try{localStorage.setItem(gsStorage.LAST_NOTICE,JSON.stringify(t))}catch(t){gsUtils.error("gsStorage","failed to save "+gsStorage.LAST_NOTICE+" to local storage",t)}},fetchLastExtensionRecoveryTimestamp:function(){var t;try{t=JSON.parse(localStorage.getItem(gsStorage.LAST_EXTENSION_RECOVERY))}catch(t){gsUtils.error("gsStorage","Failed to parse "+gsStorage.LAST_EXTENSION_RECOVERY+": ",localStorage.getItem(gsStorage.LAST_EXTENSION_RECOVERY))}return t},setLastExtensionRecoveryTimestamp:function(t){try{localStorage.setItem(gsStorage.LAST_EXTENSION_RECOVERY,JSON.stringify(t))}catch(t){gsUtils.error("gsStorage","failed to save "+gsStorage.LAST_EXTENSION_RECOVERY+" to local storage",t)}},fetchSessionMetrics:function(){var t={};try{t=JSON.parse(localStorage.getItem(gsStorage.SM_SESSION_METRICS))}catch(t){gsUtils.error("gsStorage","Failed to parse "+gsStorage.SM_SESSION_METRICS+": ",localStorage.getItem(gsStorage.SM_SESSION_METRICS))}return t},setSessionMetrics:function(t){try{localStorage.setItem(gsStorage.SM_SESSION_METRICS,JSON.stringify(t))}catch(t){gsUtils.error("gsStorage","failed to save "+gsStorage.SM_SESSION_METRICS+" to local storage",t)}}};