var gsTabSuspendManager=function(){"use strict";const e="suspendQueue";let t;function s(s,n){return void 0===s?Promise.resolve():u(s,n)?(gsUtils.log(s.id,e,"Queueing tab for suspension."),t.queueTabAsPromise(s,{forceLevel:n})):(gsUtils.log(s.id,e,"Tab not eligible for suspension."),Promise.resolve())}async function n(t,s,n,o,a){if(s.refetchTab||gsUtils.isSuspendedTab(t)){gsUtils.log(t.id,e,"Tab refetch required. Getting updated tab..");const s=await gsChrome.tabsGet(t.id);if(!s)return gsUtils.log(t.id,e,"Could not find tab with id. Will ignore suspension request"),void n(!1);t=s}if(gsUtils.isSuspendedTab(t))return void(s.refetchTab?(gsUtils.log(t.id,e,"Tab still suspended after 3 seconds. Will ignore tab suspension request"),n(!1)):(gsUtils.log(t.id,e,"Tab is already suspended. Will check again in 3 seconds"),a(3e3,{refetchTab:!0})));let u=gsStorage.getOption(gsStorage.SCREEN_CAPTURE);if("loading"===t.status){const s=await gsIndexedDb.fetchTabInfo(t.url);if("0"===u&&s){const i=gsUtils.generateSuspendedUrl(t.url,s.title,0);gsUtils.log(t.id,e,"Interrupting tab loading to resuspend tab");n(await r(t,i))}else a(3e3,{refetchTab:!0});return}gsStorage.getOption(gsStorage.DISCARD_IN_PLACE_OF_SUSPEND)&&(u="0");let c=await function(t){return new Promise((s=>{gsMessages.sendRequestInfoToContentScript(t.id,((n,i)=>{n&&gsUtils.warning(t.id,e,"Failed to get content script info",n),s(i)}))}))}(t);if(!c&&"0"!==u&&!s.reloaded)return gsUtils.log(t.id,e,"Tab is not responding. Will reload for screen capture."),await gsChrome.tabsUpdate(t.id,{url:t.url}),void a(3e4,{reloaded:!0});c=c||{status:"unknown",scrollPos:"0"};if(!function(e,t){if(t>=2&&(e===gsUtils.STATUS_FORMINPUT||e===gsUtils.STATUS_TEMPWHITELIST))return!1;return!0}(c.status,s.forceLevel))return gsUtils.log(t.id,e,`Content script status of ${c.status} not eligible for suspension. Removing tab from suspensionQueue.`),void n(!1);const p=await function(t){return new Promise((s=>{t.url.indexOf("https://www.youtube.com/watch")<0?s(t.url):gsMessages.executeCodeOnTab(t.id,`(${g})();`,((n,i)=>{if(n&&gsUtils.warning(t.id,e,"Failed to fetch YouTube timestamp",n),!i)return void s(t.url);const o=i,a=new URL(t.url);a.searchParams.set("t",o+"s"),s(a.href)}))}))}(t);t.url=p,await l(t);const b=gsUtils.generateSuspendedUrl(t.url,t.title,c.scrollPos);if(s.suspendedUrl=b,"0"!==u)s.resolveFn=n,function(t){const s=gsStorage.getOption(gsStorage.SCREEN_CAPTURE),n=gsStorage.getOption(gsStorage.SCREEN_CAPTURE_FORCE),o=gsStorage.getOption(gsStorage.USE_ALT_SCREEN_CAPTURE_LIB),a=o?"js/helpers/dom-to-image.js":"js/helpers/html2canvas.min.js";gsUtils.log(t.id,e,`Injecting ${a} into content script`),gsMessages.executeScriptOnTab(t.id,a,(e=>{e?i(t,null,"Failed to executeScriptOnTab"):gsMessages.executeCodeOnTab(t.id,`(${d})("${s}", ${n}, ${o});`,(e=>{e&&i(t,null,"Failed to executeCodeOnTab: generatePreviewImgContentScript")}))}))}(t),gsUtils.log(t.id,e,"Preview generation script started successfully.");else{n(await r(t,b))}}async function i(t,s,n){const i=o(t);if(!i)return void gsUtils.log(t.id,e,"Tab missing from suspensionQueue. Assuming suspension cancelled for this tab.");if(!u(t,i.executionProps.forceLevel))return void gsUtils.log(t.id,e,"Tab is no longer eligible for suspension. Removing tab from suspensionQueue.");const a=gsUtils.getOriginalUrl(i.executionProps.suspendedUrl);t.url=a,s?await gsIndexedDb.addPreviewImage(t.url,s):gsUtils.warning(t.id,e,"savePreviewData reported an error: ",n);const g=await r(t,i.executionProps.suspendedUrl);i.executionProps.resolveFn(g)}function o(e){return t.getQueuedTabDetails(e)}async function a(s,n,i,o,a,u){if(i===t.EXCEPTION_TIMEOUT){gsUtils.log(s.id,e,`Tab took more than ${t.getQueueProperties().jobTimeout}ms to suspend. Will force suspension.`);o(await r(s,n.suspendedUrl))}else gsUtils.warning(s.id,e,`Failed to suspend tab: ${i}`),o(!1)}function r(e,t){return new Promise((s=>(gsTabCheckManager.unqueueTabCheck(e),gsStorage.getOption(gsStorage.DISCARD_IN_PLACE_OF_SUSPEND)?(tgs.clearAutoSuspendTimerForTabId(e.id),gsTabDiscardManager.queueTabForDiscard(e),void s(!0)):gsUtils.isSuspendedTab(e,!0)?(gsUtils.log(e.id,"Tab already suspended"),void s(!1)):(t||(gsUtils.log(e.id,"executionProps.suspendedUrl not set!"),t=gsUtils.generateSuspendedUrl(e.url,e.title,0)),gsUtils.log(e.id,"Suspending tab"),void gsChrome.tabsUpdate(e.id,{url:t}).then((e=>{s(null!==e)}))))))}function u(e,t){if(t>=1&&gsUtils.isSpecialTab(e))return!1;if(t>=2&&(gsUtils.isProtectedActiveTab(e)||gsUtils.checkWhiteList(e.url)||gsUtils.isProtectedPinnedTab(e)||gsUtils.isProtectedAudibleTab(e)))return!1;if(t>=3){if(gsStorage.getOption(gsStorage.IGNORE_WHEN_OFFLINE)&&!navigator.onLine)return!1;if(gsStorage.getOption(gsStorage.IGNORE_WHEN_CHARGING)&&tgs.isCharging())return!1;if("0"===gsStorage.getOption(gsStorage.SUSPEND_TIME))return!1}return!0}function g(){const e=document.querySelector("video.video-stream.html5-main-video");return e?e.currentTime>>0:0}async function l(e){const t={date:new Date,title:e.title,url:e.url,favIconUrl:e.favIconUrl,pinned:e.pinned,index:e.index,windowId:e.windowId};await gsIndexedDb.addSuspendedTabInfo(t);const s=await gsFavicon.buildFaviconMetaFromChromeFaviconCache(e.url);s&&await gsFavicon.saveFaviconMetaDataToCache(e.url,s)}async function d(e,t,s){const n=t?1e4:5e3,i=t?.92:.5;let o,a=0,r=0;"2"===e?(a=Math.max(window.innerHeight,document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),a=Math.min(a,n)):a=window.innerHeight,r=document.body.clientWidth,o=s?()=>domtoimage.toCanvas(document.body,{}).then((e=>{const t=document.createElement("canvas"),s=t.getContext("2d");return t.width=r,t.height=a,s.drawImage(e,0,0),t})):()=>html2canvas(document.body,{height:a,width:r,logging:!1,imageTimeout:1e4,removeContainer:!1,async:!0});let u,g;try{const e=await o();(e=>{for(var t=e.getContext("2d").getImageData(0,0,e.width,e.height),s=0;s<t.data.length;s+=4){const e=0===t.data[s+3],n=255===t.data[s]&&255===t.data[s+1]&&255===t.data[s+2];if(!e&&!n)return!0}return!1})(e)?u=(e=>{let t=e.toDataURL("image/webp",i);return t&&"data:,"!==t||(t=e.toDataURL()),"data:,"===t&&(t=null),t})(e):g="Canvas contains no visible pixels"}catch(e){g=e.message}u||g||(g="Failed to generate dataUrl"),chrome.runtime.sendMessage({action:"savePreviewData",previewUrl:u,errorMsg:g})}return{initAsPromised:function(){return new Promise((async function(s){const i=gsStorage.getOption(gsStorage.SCREEN_CAPTURE),o=gsStorage.getOption(gsStorage.SCREEN_CAPTURE_FORCE);t=GsTabQueue("suspensionQueue",{concurrentExecutors:"0"===i?5:3,jobTimeout:o?3e5:6e4,executorFn:n,exceptionFn:a}),gsUtils.log(e,"init successful"),s()}))},queueTabForSuspension:function(t,n){s(t,n).catch((s=>{gsUtils.log(t.id,e,s)}))},queueTabForSuspensionAsPromise:s,unqueueTabForSuspension:function(s){t.unqueueTab(s)&&gsUtils.log(s.id,e,"Removed tab from suspension queue.")},handlePreviewImageResponse:i,saveSuspendData:l,checkTabEligibilityForSuspension:u,executeTabSuspension:r,getQueuedTabDetails:o}}();