"use strict";var gsIndexedDb={DB_SERVER:"tgs",DB_VERSION:"3",DB_PREVIEWS:"gsPreviews",DB_SUSPENDED_TABINFO:"gsSuspendedTabInfo",DB_FAVICON_META:"gsFaviconMeta",DB_CURRENT_SESSIONS:"gsCurrentSessions",DB_SAVED_SESSIONS:"gsSavedSessions",DB_SESSION_PRE_UPGRADE_KEY:"preUpgradeVersion",server:null,getDb:async function(){return gsIndexedDb.server||(gsIndexedDb.server=await db.open({server:gsIndexedDb.DB_SERVER,version:gsIndexedDb.DB_VERSION,schema:gsIndexedDb.getSchema})),gsIndexedDb.server},getSchema:function(){return{[gsIndexedDb.DB_PREVIEWS]:{key:{keyPath:"id",autoIncrement:!0},indexes:{id:{},url:{}}},[gsIndexedDb.DB_SUSPENDED_TABINFO]:{key:{keyPath:"id",autoIncrement:!0},indexes:{id:{},url:{}}},[gsIndexedDb.DB_FAVICON_META]:{key:{keyPath:"id",autoIncrement:!0},indexes:{id:{},url:{}}},[gsIndexedDb.DB_CURRENT_SESSIONS]:{key:{keyPath:"id",autoIncrement:!0},indexes:{id:{},sessionId:{}}},[gsIndexedDb.DB_SAVED_SESSIONS]:{key:{keyPath:"id",autoIncrement:!0},indexes:{id:{},sessionId:{}}}}},fetchPreviewImage:async function(e){let s;try{const t=await gsIndexedDb.getDb();s=await t.query(gsIndexedDb.DB_PREVIEWS,"url").only(e).execute()}catch(e){gsUtils.error("gsIndexedDb",e)}return s&&s.length>0?s[0]:null},addPreviewImage:async function(e,s){try{const t=await gsIndexedDb.getDb(),n=await t.query(gsIndexedDb.DB_PREVIEWS,"url").only(e).execute();if(n.length>0)for(const e of n)await t.remove(gsIndexedDb.DB_PREVIEWS,e.id);await t.add(gsIndexedDb.DB_PREVIEWS,{url:e,img:s})}catch(e){gsUtils.error("gsIndexedDb",e)}},addSuspendedTabInfo:async function(e){try{if(!e.url)return void gsUtils.error("gsIndexedDb","tabProperties.url not set.");const s=await gsIndexedDb.getDb(),t=await s.query(gsIndexedDb.DB_SUSPENDED_TABINFO).filter("url",e.url).execute();if(t.length>0)for(const e of t)await s.remove(gsIndexedDb.DB_SUSPENDED_TABINFO,e.id);await s.add(gsIndexedDb.DB_SUSPENDED_TABINFO,e)}catch(e){gsUtils.error("gsIndexedDb",e)}},fetchTabInfo:async function(e){let s;try{const t=await gsIndexedDb.getDb();s=await t.query(gsIndexedDb.DB_SUSPENDED_TABINFO,"url").only(e).distinct().desc().execute()}catch(e){gsUtils.error("gsIndexedDb",e)}if(s&&s.length>0){const e=s[0];return e.favicon&&(e.favIconUrl||(e.favIconUrl=e.favicon),delete e.favicon),e}return null},addFaviconMeta:async function(e,s){try{if(!e)return void gsUtils.error("gsIndexedDb","url not set.");const t=Object.assign(s,{url:e}),n=await gsIndexedDb.getDb(),d=await n.query(gsIndexedDb.DB_FAVICON_META).filter("url",e).execute();if(d.length>0)for(const e of d)await n.remove(gsIndexedDb.DB_FAVICON_META,e.id);await n.add(gsIndexedDb.DB_FAVICON_META,t)}catch(e){gsUtils.error("gsIndexedDb",e)}},fetchFaviconMeta:async function(e){let s;try{const t=await gsIndexedDb.getDb();s=await t.query(gsIndexedDb.DB_FAVICON_META,"url").only(e).distinct().desc().execute()}catch(e){gsUtils.error("gsIndexedDb",e)}if(s&&s.length>0){return s[0]}return null},updateSession:async function(e){try{const s=await gsIndexedDb.getDb(),t=0===e.sessionId.indexOf("_")?gsIndexedDb.DB_SAVED_SESSIONS:gsIndexedDb.DB_CURRENT_SESSIONS,n=await gsIndexedDb.fetchSessionBySessionId(e.sessionId);n?(gsUtils.log("gsIndexedDb","Updating existing session: "+e.sessionId),e.id=n.id,e.date=(new Date).toISOString(),await s.update(t,e)):(gsUtils.log("gsIndexedDb","Creating new session: "+e.sessionId),await s.add(t,e))}catch(e){gsUtils.error("gsIndexedDb",e)}},fetchCurrentSessions:async function(){let e;try{const s=await gsIndexedDb.getDb();e=await s.query(gsIndexedDb.DB_CURRENT_SESSIONS).all().desc().execute()}catch(e){gsUtils.error("gsIndexedDb",e)}return e},fetchSessionBySessionId:async function(e){let s;try{const t=await gsIndexedDb.getDb(),n=0===e.indexOf("_")?gsIndexedDb.DB_SAVED_SESSIONS:gsIndexedDb.DB_CURRENT_SESSIONS;if(s=await t.query(n,"sessionId").only(e).desc().execute(),s.length>1){gsUtils.warning("gsIndexedDb","Duplicate sessions found for sessionId: "+e+"! Removing older ones..");for(let e of s.slice(1))await t.remove(n,e.id)}}catch(e){gsUtils.error("gsIndexedDb",e)}return s&&s.length>0?s[0]:null},createOrUpdateSessionRestorePoint:async function(e,s){const t=await gsIndexedDb.fetchSessionRestorePoint(s);t?(t.windows=e.windows,await gsIndexedDb.updateSession(t),gsUtils.log("gsIndexedDb","Updated automatic session restore point")):(e.name=chrome.i18n.getMessage("js_session_save_point")+s,e[gsIndexedDb.DB_SESSION_PRE_UPGRADE_KEY]=s,await gsIndexedDb.addToSavedSessions(e),gsUtils.log("gsIndexedDb","Created automatic session restore point"));const n=await gsIndexedDb.fetchSessionRestorePoint(s);return gsUtils.log("gsIndexedDb","New session restore point:",n),n},fetchSessionRestorePoint:async function(e){let s;try{const t=await gsIndexedDb.getDb(),n=gsIndexedDb.DB_SAVED_SESSIONS;s=await t.query(n).filter(gsIndexedDb.DB_SESSION_PRE_UPGRADE_KEY,e).distinct().execute()}catch(e){gsUtils.error("gsIndexedDb",e)}return s&&s.length>0?s[0]:null},fetchLastSession:async function(){let e;try{const s=await gsIndexedDb.getDb();e=await s.query(gsIndexedDb.DB_CURRENT_SESSIONS,"id").all().desc().execute()}catch(e){gsUtils.error("gsIndexedDb",e)}if(e&&e.length>0){const s=gsSession.getSessionId();return e.find((e=>e.sessionId!==s))}return null},fetchSavedSessions:async function(){let e;try{const s=await gsIndexedDb.getDb();e=await s.query(gsIndexedDb.DB_SAVED_SESSIONS).all().execute()}catch(e){gsUtils.error("gsIndexedDb",e)}return e},addToSavedSessions:async function(e){e.sessionId.indexOf("_")<0&&(e.sessionId="_"+gsUtils.generateHashCode(e.name)),delete e.id,await gsIndexedDb.updateSession(e)},clearGsDatabase:async function(){try{const e=await gsIndexedDb.getDb();await e.clear(gsIndexedDb.DB_CURRENT_SESSIONS),await e.clear(gsIndexedDb.DB_SAVED_SESSIONS)}catch(e){gsUtils.error("gsIndexedDb",e)}},removeTabFromSessionHistory:async function(e,s,t){const n=await gsIndexedDb.fetchSessionBySessionId(e);n.windows.some((function(e,s){if(e.tabs.some((function(s,n){if(s.id==t||s.url==t)return e.tabs.splice(n,1),!0})))return 0===e.tabs.length&&n.windows.splice(s,1),!0})),n.windows.length>0?await gsIndexedDb.updateSession(n):await gsIndexedDb.removeSessionFromHistory(e);return await gsIndexedDb.fetchSessionBySessionId(e)},removeSessionFromHistory:async function(e){const s=0===e.indexOf("_")?gsIndexedDb.DB_SAVED_SESSIONS:gsIndexedDb.DB_CURRENT_SESSIONS;try{const t=await gsIndexedDb.getDb(),n=await t.query(s).filter("sessionId",e).execute();if(n.length>0){const e=n[0];await t.remove(s,e.id)}}catch(e){gsUtils.error("gsIndexedDb",e)}},trimDbItems:async function(){const e=1e3;try{const s=await gsIndexedDb.getDb(),t=await s.query(gsIndexedDb.DB_SUSPENDED_TABINFO,"id").all().keys().execute();if(t.length>e){const n=t.length-e;for(let e=0;e<n;e++)await s.remove(gsIndexedDb.DB_SUSPENDED_TABINFO,t[e])}const n=await s.query(gsIndexedDb.DB_FAVICON_META,"id").all().keys().execute(),d=parseInt(1300);if(n.length>d){const e=n.length-d;for(let t=0;t<e;t++)await s.remove(gsIndexedDb.DB_FAVICON_META,n[t])}const i=await s.query(gsIndexedDb.DB_PREVIEWS,"id").all().keys().execute();if(i.length>e){const t=i.length-e;for(let e=0;e<t;e++)await s.remove(gsIndexedDb.DB_PREVIEWS,i[e])}const a=await s.query(gsIndexedDb.DB_CURRENT_SESSIONS,"id").all().keys().execute();if(a.length>5){const e=a.length-5;for(let t=0;t<e;t++)await s.remove(gsIndexedDb.DB_CURRENT_SESSIONS,a[t])}}catch(e){gsUtils.error("gsIndexedDb",e)}},performMigration:async function(e){try{const s=await gsIndexedDb.getDb(),t=chrome.runtime.getManifest().name||"",n=parseInt(e.split(".")[0]||0),d=parseInt(e.split(".")[1]||0),i=t.includes("Test");if(n<6||6===n&&d<13){const e=await s.query(gsIndexedDb.DB_SAVED_SESSIONS).all().execute();for(const t of e)7777===t.id?(t.sessionId="_7777",t.name="Recovered tabs",t.date=new Date(t.date).toISOString()):t.sessionId="_"+gsUtils.generateHashCode(t.name),await s.update(gsIndexedDb.DB_SAVED_SESSIONS,t)}if((n<6||6===n&&d<30)&&(gsIndexedDb.getOption("preview")?"0.1"===gsIndexedDb.getOption("previewQuality")?gsIndexedDb.setOption(gsIndexedDb.SCREEN_CAPTURE,"1"):gsIndexedDb.setOption(gsIndexedDb.SCREEN_CAPTURE,"2"):gsIndexedDb.setOption(gsIndexedDb.SCREEN_CAPTURE,"0")),n<6||6===n&&d<31||i){const e=await gsChrome.cookiesGetAll(),s={};for(const t of e)if(0===t.name.indexOf("gsScrollPos")){if(t.value&&"0"!==t.value){s[t.name.substr(12)]=t.value}let e=t.secure?"https://":"http://";"."===t.domain.charAt(0)&&(e+="www");const n=e+t.domain+t.path;await gsChrome.cookiesRemove(n,t.name)}tgs.scrollPosByTabId=s}}catch(e){gsUtils.error("gsIndexedDb",e)}}};