var gsFavicon=function(){"use strict";const a={favIconUrl:"chrome://favicon/size/16@2x/fallbackChromeFaviconMeta",isDark:!0,normalisedDataUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAYklEQVQ4T2NkoBAwIuuPior6j8O8xmXLljVgk8MwYNmyZdgMfcjAwLAAmyFEGfDv3z9FJiamA9gMIcoAkKsiIiIUsBlClAHofkf2JkED0DWDAnrUgOEfBsRkTpzpgBjN6GoA24V1Efr1zoAAAAAASUVORK5CYII=",transparentDataUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAaUlEQVQ4T2NkoBAwIuuPioqqx2YeExPTwSVLlhzAJodhwLJlyxrRDWVkZPzIyMh4AZshRBnAxsY28ffv3wnYDCHKAJCrEhISBLAZQpQB6H5H9iZBA9A1gwJ61IDhHwbEZE6c6YAYzehqAAmQeBHM42eMAAAAAElFTkSuQmCC"},t={};let n;async function e(a){let n;try{n=await gsUtils.executeWithRetries(l,[a],4,0)}catch(a){gsUtils.warning("gsFavicon",a)}return async function(a,n){t[n]=await c(a.normalisedDataUrl),t[n+"Transparent"]=await c(a.transparentDataUrl)}(n,a),n}function i(a){return"chrome://favicon/size/16@2x/"+a}async function o(a){const t=i(a);gsUtils.log("gsFavicon",`Building faviconMeta from url: ${t}`);try{const a=await l(t);if(await r(a))return a}catch(a){gsUtils.warning("gsUtils",a)}return null}async function s(a,t){const n=gsUtils.getRootUrl(a,!0,!1),e=gsUtils.getRootUrl(a,!1,!1);gsUtils.log("gsFavicon","Saving favicon cache entry for: "+n,t),await gsIndexedDb.addFaviconMeta(n,Object.assign({},t)),await gsIndexedDb.addFaviconMeta(e,Object.assign({},t))}async function r(a){if(!a||"data:,"===a.normalisedDataUrl||"data:,"===a.transparentDataUrl)return!1;const n=await c(a.normalisedDataUrl),e=await c(a.transparentDataUrl);for(let i of Object.keys(t)){const o=t[i];if(n===o||e===o)return gsUtils.log("gsFavicon","FaviconMeta not valid as it matches fingerprint of default favicon: "+i,a),!1}return!0}function c(a){return new Promise((t=>{const n=new Image;n.onload=async function(){const a=window.document.createElement("canvas"),e=a.getContext("2d");a.width=16,a.height=16,e.drawImage(n,0,0,16,16);const i=e.getImageData(0,0,16,16);for(var o=0;o<i.data.length;o+=4){var s=Math.floor(.3*i.data[o]+.59*i.data[o+1]+.11*i.data[o+2]);i.data[o]=i.data[o+1]=i.data[o+2]=s>80?255:0,i.data[o+3]=255}e.putImageData(i,0,0);const r=a.toDataURL("image/png");t(r)},n.src=a}))}function l(a){return new Promise(((t,n)=>{const e=new Image;e.crossOrigin="Anonymous";let i=!1;e.onload=()=>{let o,s,r;i=!0,o=window.document.createElement("canvas"),o.width=e.width,o.height=e.height,s=o.getContext("2d"),s.drawImage(e,0,0);try{r=s.getImageData(0,0,o.width,o.height)}catch(a){return void n(a)}const c=r.data,l=new Uint8ClampedArray(c),g=new Uint8ClampedArray(c);let f,d,A,m,u=0,h=0,U=0,v=0;for(let a=0;a<c.length;a+=4){f=c[a],d=c[a+1],A=c[a+2],m=c[a+3];let t=Math.max(Math.max(f,d),A);t<128||m<128?h++:u++,U=Math.max(m,U),v=Math.max(t,v)}if(0===U)return void n("Aborting favicon generation as image is completely transparent. url: "+a);const w=(u-h)/(o.width*o.height)+.1<0,D=1/(U/255);for(let a=0;a<c.length;a+=4)m=c[a+3],l[a+3]=parseInt(m*D,10);for(let a=0;a<l.length;a+=4)m=l[a+3],g[a+3]=parseInt(.5*m,10);r.data.set(l),s.putImageData(r,0,0);const p=o.toDataURL("image/png");r.data.set(g),s.putImageData(r,0,0);const F=o.toDataURL("image/png");t({favIconUrl:a,isDark:w,normalisedDataUrl:p,transparentDataUrl:F})},e.src=a,setTimeout((()=>{i||n("Failed to load img.src of: "+a)}),5e3)}))}return{initAsPromised:async function(){await async function(){const t=[i("http://chromeDefaultFavicon"),i("chromeDefaultFavicon"),chrome.extension.getURL("images/icon-16x16.png"),chrome.extension.getURL("images/ch-def-favicon.png"),chrome.extension.getURL("images/ch-def-favicon-sml.png"),chrome.extension.getURL("images/ch-dev-def-favicon.png"),chrome.extension.getURL("images/ch-dev-def-favicon-sml.png")],o=[];for(let i=0;i<t.length;i+=1){const s=t[i];o.push(new Promise((async t=>{const o=await e(s);o?gsUtils.log("gsFavicon",`Successfully built default faviconMeta for url: ${s}`,o):gsUtils.warning("gsFavicon",`Failed to build faviconMeta for url: ${s}`),0===i&&(n=o||a,gsUtils.log("gsFavicon","Set _defaultChromeFaviconMeta",n)),t()})))}await Promise.all(o)}(),gsUtils.log("gsFavicon","init successful")},getFaviconMetaData:async function(a){if(gsUtils.isFileTab(a))return n;let t=a.url;gsUtils.isSuspendedTab(a)&&(t=gsUtils.getOriginalUrl(a.url));let e=await async function(a){const t=gsUtils.getRootUrl(a,!0,!1);let n=await gsIndexedDb.fetchFaviconMeta(t);if(!n){const t=gsUtils.getRootUrl(a,!1,!1);n=await gsIndexedDb.fetchFaviconMeta(t)}return n||null}(t);return e||(e=await o(t),e?(gsUtils.log(a.id,"Saving faviconMeta from chrome://favicon into cache",e),await s(t,e),e):(gsUtils.log(a.id,"No entry in chrome favicon cache for url: "+t),a.favIconUrl&&a.favIconUrl!==chrome.extension.getURL("images/icon-16x16.png")&&(e=await async function(a){try{const t=await l(a);if(await r(t))return t}catch(a){gsUtils.warning("gsUtils",a)}return null}(a.favIconUrl),e)?(gsUtils.log(a.id,"Built faviconMeta from tab.favIconUrl",e),e):(gsUtils.log(a.id,"Failed to build faviconMeta. Using default icon"),n)))},generateChromeFavIconUrlFromUrl:i,buildFaviconMetaFromChromeFaviconCache:o,saveFaviconMetaDataToCache:s}}();