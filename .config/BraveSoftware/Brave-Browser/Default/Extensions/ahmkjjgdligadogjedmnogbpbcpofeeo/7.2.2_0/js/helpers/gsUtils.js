"use strict";var debugInfo=!1,debugError=!1,gsUtils={STATUS_NORMAL:"normal",STATUS_LOADING:"loading",STATUS_SPECIAL:"special",STATUS_BLOCKED_FILE:"blockedFile",STATUS_SUSPENDED:"suspended",STATUS_DISCARDED:"discarded",STATUS_NEVER:"never",STATUS_FORMINPUT:"formInput",STATUS_AUDIBLE:"audible",STATUS_ACTIVE:"active",STATUS_TEMPWHITELIST:"tempWhitelist",STATUS_PINNED:"pinned",STATUS_WHITELISTED:"whitelisted",STATUS_CHARGING:"charging",STATUS_NOCONNECTIVITY:"noConnectivity",STATUS_UNKNOWN:"unknown",contains:function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1},dir:function(e){},log:function(e,t,...n){debugInfo&&(n=n||[])},warning:function(e,t,...n){if(debugError){n=n||[];const e=["Error","gsUtils","gsMessages"],t=gsUtils.getStackTrace().split("\n").filter((t=>!e.find((e=>t.indexOf(e)>=0)))).join("\n");n.push(`\n${t}`)}},errorIfInitialised:function(e,t,...n){n=n||[],gsSession.isInitialising()?gsUtils.warning(e,t,n):gsUtils.error(e,t,n)},error:function(e,t,...n){if(void 0===t&&(t=e,e="?"),debugError){t.hasOwnProperty("stack")?t.stack:gsUtils.getStackTrace(),t.hasOwnProperty("message")?t.message:"string"==typeof t||JSON.stringify(t,null,2);t=t||{}}},getPrintableError(e,t,...n){let s=e;return s+=`\n${n.map((e=>JSON.stringify(e,null,2))).join("\n")}`,s+=`\n${t}`,s},getStackTrace:function(){var e={};return Error.captureStackTrace(e,gsUtils.getStackTrace),e.stack},isDebugInfo:function(){return debugInfo},isDebugError:function(){return debugError},setDebugInfo:function(e){debugInfo=e},setDebugError:function(e){debugError=e},isDiscardedTab:function(e){return e.discarded},isSpecialTab:function(e){var t=e.url;return!gsUtils.isSuspendedUrl(t,!0)&&!(0!==t.indexOf("about")&&0!==t.indexOf("chrome")&&!gsUtils.isBlockedFileTab(e))},isFileTab:function(e){return 0===e.url.indexOf("file")},isBlockedFileTab:function(e){return!(!gsUtils.isFileTab(e)||gsSession.isFileUrlsAccessAllowed())},isInternalTab:function(e){return 0===e.url.indexOf("chrome-extension://"+chrome.runtime.id)&&!gsUtils.isSuspendedUrl(e.url)},isProtectedPinnedTab:function(e){return gsStorage.getOption(gsStorage.IGNORE_PINNED)&&e.pinned},isProtectedAudibleTab:function(e){return gsStorage.getOption(gsStorage.IGNORE_AUDIO)&&e.audible},isProtectedActiveTab:function(e){var t=gsStorage.getOption(gsStorage.IGNORE_ACTIVE_TABS);return tgs.isCurrentFocusedTab(e)||t&&e.active},isNormalTab:function(e,t){return t=t||!1,!(gsUtils.isSpecialTab(e)||gsUtils.isSuspendedTab(e,!0)||t&&gsUtils.isDiscardedTab(e))},isSuspendedTab:function(e,t){return gsUtils.isSuspendedUrl(e.url,t)},isSuspendedUrl:function(e,t){return t?e.indexOf("html/suspended.html")>0:0===e.indexOf(chrome.extension.getURL("html/suspended.html"))},shouldSuspendDiscardedTabs:function(){var e=gsStorage.getOption(gsStorage.SUSPEND_IN_PLACE_OF_DISCARD),t=gsStorage.getOption(gsStorage.DISCARD_IN_PLACE_OF_SUSPEND);return e&&!t},removeTabsByUrlAsPromised:function(e){return new Promise((async t=>{const n=await gsChrome.tabsQuery({url:e});chrome.tabs.remove(n.map((e=>e.id)),(()=>{t()}))}))},createTabAndWaitForFinishLoading:function(e,t){return new Promise((async n=>{let s=await gsChrome.tabsCreate(e);t=t||1e3;const i=Date.now()+t;let r=!1;for(;!r&&Date.now()<i;)s=await gsChrome.tabsGet(s.id),r="complete"===s.status,r||await gsUtils.setTimeout(200);n(s)}))},createWindowAndWaitForFinishLoading:function(e,t){return new Promise((async n=>{let s=await gsChrome.windowsCreate(e);t=t||1e3;const i=Date.now()+t;let r=!1;for(;!r&&Date.now()<i;)s=await gsChrome.windowsGet(s.id),r=s.tabs.length>0&&"complete"===s.tabs[0].status,r||await gsUtils.setTimeout(200);n(s)}))},checkWhiteList:function(e){return gsUtils.checkSpecificWhiteList(e,gsStorage.getOption(gsStorage.WHITELIST))},checkSpecificWhiteList:function(e,t){return(t?t.split(/[\s\n]+/):[]).some((function(t){return gsUtils.testForMatch(t,e)}),this)},removeFromWhitelist:function(e){var t,n=gsStorage.getOption(gsStorage.WHITELIST)||"",s=n.split(/[\s\n]+/).sort();for(t=s.length-1;t>=0;t--)gsUtils.testForMatch(s[t],e)&&s.splice(t,1);var i=s.join("\n");gsStorage.setOptionAndSync(gsStorage.WHITELIST,i);var r=gsStorage.WHITELIST;gsUtils.performPostSaveUpdates([r],{[r]:n},{[r]:i})},testForMatch:function(e,t){if(e.length<1)return!1;if(e.length>2&&0===e.indexOf("/")&&-1!==e.indexOf("/",e.length-1)){e=e.substring(1,e.length-1);try{new RegExp(e)}catch(e){return!1}return new RegExp(e).test(t)}return t.indexOf(e)>=0},saveToWhitelist:function(e){var t=gsStorage.getOption(gsStorage.WHITELIST)||"",n=t+"\n"+e;n=gsUtils.cleanupWhitelist(n),gsStorage.setOptionAndSync(gsStorage.WHITELIST,n);var s=gsStorage.WHITELIST;gsUtils.performPostSaveUpdates([s],{[s]:t},{[s]:n})},cleanupWhitelist:function(e){var t,n,s=e?e.split(/[\s\n]+/).sort():"";for(t=s.length-1;t>=0;t--)(n=s.lastIndexOf(s[t]))!==t&&s.splice(t+1,n-t),s[t]&&""!==s[t]||s.splice(t,1);return s.length?s.join("\n"):s},documentReadyAsPromsied:function(e){return new Promise((function(t){"loading"!==e.readyState?t():e.addEventListener("DOMContentLoaded",(function(){t()}))}))},localiseHtml:function(e){var t=function(e,t){return t?chrome.i18n.getMessage(t):""};for(let n of e.getElementsByTagName("*"))n.hasAttribute("data-i18n")&&(n.innerHTML=n.getAttribute("data-i18n").replace(/__MSG_(\w+)__/g,t).replace(/\n/g,"<br />")),n.hasAttribute("data-i18n-tooltip")&&n.setAttribute("data-i18n-tooltip",n.getAttribute("data-i18n-tooltip").replace(/__MSG_(\w+)__/g,t))},documentReadyAndLocalisedAsPromsied:async function(e){await gsUtils.documentReadyAsPromsied(e),gsUtils.localiseHtml(e),e.body&&e.body.hidden&&(e.body.hidden=!1)},generateSuspendedUrl:function(e,t,n){var s="#ttl="+gsUtils.encodeString(t)+"&pos="+(n||"0")+"&uri="+e;return chrome.extension.getURL("html/suspended.html"+s)},getRootUrl:function(e,t,n){let s,i=e;if(i.indexOf("//")>0&&(s=i.substring(0,i.indexOf("//")+2),i=i.substring(i.indexOf("//")+2)),t){var r=i.match(/\/?[?#]+/);r&&(i=i.substring(0,r.index)),(r=i.match(/\/$/))&&(i=i.substring(0,r.index))}else if("file://"===s)i=i.replace(new RegExp("/[^/]*$","g"),"");else{const e=i.indexOf("/")>0?i.indexOf("/"):i.length;i=i.substring(0,e)}return s&&n&&(i=s+i),i},getHashVariable:function(e,t){var n,s={},i=/^(.+)=(.+)/;if(!t||0===t.length||-1===t.indexOf("#"))return!1;if(0===(n=t.replace(/^[^#]+#+(.*)/,"$1")).length)return!1;let r=n.indexOf("uri=");return r>=0&&(s.uri=n.substr(r+4),n=n.substr(0,r)),n.split("&").forEach((function(e){e&&e.match(i)&&(s[e.replace(i,"$1")]=e.replace(i,"$2"))})),s[e]||!1},getSuspendedTitle:function(e){return gsUtils.decodeString(gsUtils.getHashVariable("ttl",e)||"")},getSuspendedScrollPosition:function(e){return gsUtils.decodeString(gsUtils.getHashVariable("pos",e)||"")},getOriginalUrl:function(e){return gsUtils.getHashVariable("uri",e)||gsUtils.decodeString(gsUtils.getHashVariable("url",e)||"")},getCleanTabTitle:function(e){let t=gsUtils.decodeString(e.title);return t&&""!==t&&t!==gsUtils.decodeString(e.url)&&"Suspended Tab"!==t||(t=gsUtils.isSuspendedTab(e)?gsUtils.getSuspendedTitle(e.url)||gsUtils.getOriginalUrl(e.url):e.url),t},decodeString:function(e){try{return decodeURIComponent(e)}catch(t){return e}},encodeString:function(e){try{return encodeURIComponent(e)}catch(t){return e}},formatHotkeyString:function(e){return e.replace(/Command/,"⌘").replace(/[⌘\u2318]/," ⌘ ").replace(/[⇧\u21E7]/," Shift ").replace(/[⌃\u8963]/," Ctrl ").replace(/[⌥\u8997]/," Option ").replace(/\+/g," ").replace(/ +/g," ").trim().replace(/[ ]/g," · ")},getSuspendedTabCount:async function(){return(await gsChrome.tabsQuery()).filter((e=>gsUtils.isSuspendedTab(e))).length},htmlEncode:function(e){return document.createElement("pre").appendChild(document.createTextNode(e)).parentNode.innerHTML},getChromeVersion:function(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return!!e&&parseInt(e[2],10)},generateHashCode:function(e){var t,n,s=0;if(!e)return s;for(t=0,n=e.length;t<n;t++)s=(s<<5)-s+e.charCodeAt(t),s|=0;return Math.abs(s)},getAllExpiredTabs:function(e){var t=[];chrome.tabs.query({},(n=>{for(const e of n){const n=tgs.getTabStatePropForTabId(e.id,tgs.STATE_TIMER_DETAILS);n&&n.suspendDateTime&&new Date(n.suspendDateTime)<new Date&&t.push(e)}e(t)}))},performPostSaveUpdates:function(e,t,n){if(chrome.tabs.query({},(function(s){s.forEach((function(s){if(gsUtils.isSpecialTab(s))return;if(gsUtils.isSuspendedTab(s)){if(e.includes(gsStorage.IGNORE_PINNED)&&gsUtils.isProtectedPinnedTab(s)||e.includes(gsStorage.IGNORE_ACTIVE_TABS)&&gsUtils.isProtectedActiveTab(s))return void tgs.unsuspendTab(s);const t=e.includes(gsStorage.THEME),n=e.includes(gsStorage.SCREEN_CAPTURE);if(t||n){const e=tgs.getInternalViewByTabId(s.id);if(e){if(t){const t=gsStorage.getOption(gsStorage.THEME);gsFavicon.getFaviconMetaData(s).then((n=>{const i=n.isDark||!1;gsSuspendedTab.updateTheme(e,s,t,i)}))}if(n){const t=gsStorage.getOption(gsStorage.SCREEN_CAPTURE);gsSuspendedTab.updatePreviewMode(e,s,t)}}}return void(e.includes(gsStorage.DISCARD_AFTER_SUSPEND)&&gsStorage.getOption(gsStorage.DISCARD_AFTER_SUSPEND)&&gsUtils.isSuspendedTab(s)&&!gsUtils.isDiscardedTab(s)&&gsTabDiscardManager.queueTabForDiscard(s))}if(!gsUtils.isNormalTab(s,!0))return;e.includes(gsStorage.IGNORE_FORMS)&&gsMessages.sendUpdateToContentScriptOfTab(s);(e.includes(gsStorage.SUSPEND_TIME)||e.includes(gsStorage.IGNORE_ACTIVE_TABS)&&s.active||e.includes(gsStorage.IGNORE_PINNED)&&!gsStorage.getOption(gsStorage.IGNORE_PINNED)&&s.pinned||e.includes(gsStorage.IGNORE_AUDIO)&&!gsStorage.getOption(gsStorage.IGNORE_AUDIO)&&s.audible||e.includes(gsStorage.IGNORE_WHEN_OFFLINE)&&!gsStorage.getOption(gsStorage.IGNORE_WHEN_OFFLINE)&&!navigator.onLine||e.includes(gsStorage.IGNORE_WHEN_CHARGING)&&!gsStorage.getOption(gsStorage.IGNORE_WHEN_CHARGING)&&tgs.isCharging()||e.includes(gsStorage.WHITELIST)&&gsUtils.checkSpecificWhiteList(s.url,t[gsStorage.WHITELIST])&&!gsUtils.checkSpecificWhiteList(s.url,n[gsStorage.WHITELIST]))&&tgs.resetAutoSuspendTimerForTab(s);e.includes(gsStorage.SUSPEND_IN_PLACE_OF_DISCARD)&&gsUtils.isDiscardedTab(s)&&gsTabDiscardManager.handleDiscardedUnsuspendedTab(s)}))})),gsUtils.contains(e,gsStorage.ADD_CONTEXT)){var s=gsStorage.getOption(gsStorage.ADD_CONTEXT);tgs.buildContextMenu(s)}(gsUtils.contains(e,gsStorage.SCREEN_CAPTURE)||gsUtils.contains(e,gsStorage.SCREEN_CAPTURE_FORCE))&&gsTabSuspendManager.initAsPromised()},getWindowFromSession:function(e,t){var n=!1;return t.windows.some((function(t){if(t.id==e)return n=t,!0})),n},removeInternalUrlsFromSession:function(e){if(e&&e.windows)for(var t=e.windows.length-1;t>=0;t--){for(var n=e.windows[t],s=n.tabs.length-1;s>=0;s--){var i=n.tabs[s];gsUtils.isInternalTab(i)&&n.tabs.splice(s,1)}0===n.tabs.length&&e.windows.splice(t,1)}},getSimpleDate:function(e){var t=new Date(e);return("0"+t.getDate()).slice(-2)+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+t.getFullYear()+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)},getHumanDate:function(e){var t=new Date(e),n=t.getDate(),s=t.getMonth(),i=t.getFullYear(),r=t.getHours(),a=r>=12?"pm":"am",o=r%12||12,g=("0"+t.getMinutes()).slice(-2);return n+" "+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][s]+" "+i+" "+o+":"+g+a},debounce:function(e,t){var n;return function(){var s=this,i=arguments,r=function(){n=null,e.apply(s,i)};clearTimeout(n),n=setTimeout(r,t)}},setTimeout:async function(e){return new Promise((t=>{window.setTimeout(t,e)}))},executeWithRetries:async function(e,t,n,s){const i=async r=>{try{return await e(...t)}catch(e){return r>=n?(gsUtils.warning("gsUtils","Max retries exceeded"),Promise.reject(e)):(r+=1,await gsUtils.setTimeout(s),await i(r))}};return await i(0)}};